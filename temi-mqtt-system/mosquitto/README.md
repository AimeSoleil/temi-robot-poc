# MQTT Broker (Mosquitto)

MQTT message broker for the temi-robot-poc system. Runs via **Docker Compose** using the official [Eclipse Mosquitto](https://mosquitto.org/) image.

## Architecture

```
Phone App ─── publishes ──→  ┌────────────────────────┐  ←── subscribes ─── Relay App
              temi/command   │  Mosquitto Broker       │      temi/command
                             │  (eclipse-mosquitto:2)  │
Phone App ←── subscribes ──  │  Port 1883 (MQTT)       │  ──→ publishes ─── Relay App
              temi/status    │  Port 9001 (WebSocket)   │      temi/status
                             └────────────────────────┘
```

The broker acts as the central communication hub — no direct connection between phone and relay is needed.

## Prerequisites

| Dependency | Version |
|------------|---------|
| [Docker](https://docs.docker.com/get-docker/) | 20.10+ |
| [Docker Compose](https://docs.docker.com/compose/install/) | v2+ |
| A server/machine reachable on the same network as both the phone and temi robot |

## Installation

### Quick Start

```bash
cd temi-mqtt-system/mosquitto
chmod +x setup.sh
./setup.sh
```

The `setup.sh` script will:

1. Generate a hashed password file using `mosquitto_passwd` (inside a temporary Docker container)
2. Start the Mosquitto broker container in the background via `docker compose up -d`

### Verify

```bash
docker ps
```

You should see a container named **`temi-mqtt-broker`** running with ports `1883` and `9001` mapped.

### Note Your Server IP

Both Android apps need the broker's IP address:

```bash
# macOS
ipconfig getifaddr en0

# Linux
hostname -I
```

## Configuration

### Default Credentials

| Setting | Value |
|---------|-------|
| Username | `temi` |
| Password | `temi2026` |

> **Security:** For production, change credentials by editing `setup.sh` before first run, or manually update the password file:
> ```bash
> docker run --rm -v $(pwd)/password.txt:/tmp/pw eclipse-mosquitto:2 \
>     mosquitto_passwd -b /tmp/pw temi YOUR_NEW_PASSWORD
> docker compose restart
> ```

### Ports

| Port | Protocol | Purpose |
|------|----------|---------|
| **1883** | MQTT (TCP) | Standard MQTT connections from Android apps |
| **9001** | WebSocket | WebSocket-based MQTT (for web clients or debugging tools) |

### mosquitto.conf

| Setting | Value | Description |
|---------|-------|-------------|
| `persistence` | `true` | Retained messages survive broker restarts |
| `log_dest` | `file /mosquitto/log/mosquitto.log` | Log to file inside the container |
| `listener 1883` | protocol `mqtt` | Main MQTT listener |
| `listener 9001` | protocol `websockets` | WebSocket listener |
| `allow_anonymous` | `false` | Require username/password authentication |
| `password_file` | `/mosquitto/config/password.txt` | Path to the hashed credentials file |

## File Structure

```
mosquitto/
├── docker-compose.yml    ← Container definition, port mappings, volumes
├── mosquitto.conf        ← Broker configuration (listeners, auth, logging)
├── setup.sh              ← One-command setup: generates password + starts broker
└── password.txt          ← Hashed credentials (auto-generated by setup.sh)
```

## Operations

### Start / Stop / Restart

```bash
cd temi-mqtt-system/mosquitto

# Start (foreground)
docker compose up

# Start (background)
docker compose up -d

# Stop
docker compose down

# Restart
docker compose restart
```

### View Logs

```bash
# Live logs
docker compose logs -f

# Or read the log file inside the container
docker exec temi-mqtt-broker cat /mosquitto/log/mosquitto.log
```

### Test Connectivity

Use any MQTT client to verify the broker is working. For example, with `mosquitto_pub` / `mosquitto_sub`:

```bash
# Terminal 1 – subscribe
docker exec temi-mqtt-broker mosquitto_sub -u temi -P temi2026 -t "test/hello"

# Terminal 2 – publish
docker exec temi-mqtt-broker mosquitto_pub -u temi -P temi2026 -t "test/hello" -m "Hello from broker"
```

Or use a GUI tool like [MQTTX](https://mqttx.app/) to connect to `mqtt://YOUR_SERVER_IP:1883`.

## MQTT Topics

| Topic | Direction | Description |
|-------|-----------|-------------|
| `temi/command` | Phone → Relay | Location update commands (JSON) |
| `temi/status` | Relay → Phone | Repose status, calibration status, errors |

See the [root README](../../README.md) for full message payload specifications.

## Troubleshooting

| Problem | Solution |
|---------|----------|
| Container won't start | Check Docker is running: `docker info` |
| Port already in use | Another process is using 1883/9001. Run `lsof -i :1883` to find it. |
| Connection refused from apps | Ensure the server IP is correct and firewall allows 1883. Try `telnet YOUR_IP 1883`. |
| Authentication error | Re-run `setup.sh` to regenerate the password file, or manually reset credentials. |
| Broker stops unexpectedly | Check logs: `docker compose logs` — look for config errors or permission issues. |
